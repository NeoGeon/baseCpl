# baseCpl的实现功能需求与接口描述

## 1,功能
目前需要实现的需求有：进程管理，数据交换，插值，时间管理
### 进程管理
       暂定使用CESM/CPL7的管理模式，即有top driver的模式，通过建立通信组，来交换数据。
### 数据交换
        数据交换将使用MCT的rearranger来实现
### 插值
        目前只需要留出插值的接口，我们仅仅使用一个满秩矩阵即可
### 时间管理
        第一次实现，可以使用计数器，之后需要修改一下，关键是如何表示耦合频率
## 2，项目目录组织
  /baseCpl</br>
      &emsp;/cpl </br>
      &emsp;&emsp;/procManage</br>
      &emsp;&emsp;/transfer</br>
      &emsp;&emsp;/TimeManger</br>
      &emsp;/model1</br>
      &emsp;/model2</br>
      &emsp;/model3</br>

## 3,代码实现

### 代码简介
主要过程由init,run,final三个过程组成，init设置进程组，初始化时间，各个模式分量的变量初始化，耦合设置的初始化，run执行耦合过程，调用模式的模拟执行过程，并在该模式应该交换数据的时间交换数据，这个过程需要执行到时间满足终止条件;final阶段，释放相应的变量。具体间接口描述的一小节

### 具体实现
#### 进程管理的实现(目前不考虑面向对象技术)
目前拟采用CESM/CPL7的管理方式：第一，只有一个可执行文件，将其部署到不同进程，而不是不同模式使用不同的可执行文件。第二，通过建立一个全局的进程通信组，再通过在这个进程组里面划分各个分量模式的通信组，分量模式通过与耦合器进程组合并来完成分量模式数据到耦合器的传输，插值。现在需要在初始化阶段完成各个通信域的进程分派。此外，进程需要管理用于描述改进程执行任务特点的数据，如，属于那个模式的iam_model,是否执行某个模式，是否记录数据等等。

#### 数据交换的实现
数据交换涉及到数据从分量模式传到耦合器（目前仅支持这种模式，是否之后支持直接交换，另作讨论），由于验证阶段我们主要使用MCT，所以数据传输可以使用一下几个API，MCT_Send, MCT_Recv, Router, Rearranger, sparseMatrixPlus等等。暂时定下来使用Rearranger。问题是数据交换部分应该如何封装：第一，采用类似于seq_map_map函数的方式，实现三种数据交换方式;第二,实现一个数据交换类，这个类需要保证可以兼容多种数据交换方式

#### 插值的实现
插值的实现也涉及到交换，不过我们应该只需要留下接口即可，目前实现的插值过程应该使用稀疏矩阵乘法，矩阵应该选择对角矩阵，具体API使用mct的sparseMatrix。

#### 时间管理的实现
使用ESMF？


## 4,接口描述

运用面向对象技术，实现具有高可读性，灵活性的耦合器代码。我们将分别实现一下三种主要的类：
进程管理类，数据交换类，时间管理类。然后按照特定的顺序调用这些接口，以实现多个分量模式的耦合。
### 进程管理类
现阶段的进程管理类按照以下方式实现：</br>
&emsp;进程管理类应该包含该进程所属哪一个模式分量通信域，目前的一个小问题是如何区分耦合器进程组，模式分量进程组联合通信组和模式分量进程组;</br>
&emsp;需要有一个数据结构管理本进程含有的标志集合，这是耦合器控制的核心，目前设计要么硬编程到程序里面，要么通过读文件之后计算特定值的方式设置标志集合;</br>
&emsp;需要有一个接口通过配置文件来分配各个进程需要执行哪一个模式分量</br>
目前先实现以上的功能
### 数据交换类

### 时间管理类
